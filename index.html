import React, { useState, useEffect } from 'react';
import { Plus, Trash2, Calculator, BookOpen, GraduationCap, RotateCcw, Save, FlaskConical, Languages, Calculator as CalcIcon, Globe, Palette, MoreHorizontal, LayoutGrid, Target, CheckCircle2, XCircle, ChevronDown, ChevronUp, Calendar, HeartPulse, Briefcase, FileSpreadsheet, Printer } from 'lucide-react';

export default function App() {
  const [subjects, setSubjects] = useState([]);
  
  // Default setup
  const [newSubject, setNewSubject] = useState({ 
    term: 'ป.4 เทอม 1',
    name: '', 
    credit: '1.5', 
    grade: '4', 
    category: 'Math' 
  });
  
  const [gpa, setGpa] = useState(0.00);
  const [totalCredits, setTotalCredits] = useState(0);
  const [categoryStats, setCategoryStats] = useState({});
  const [termStats, setTermStats] = useState({}); // New: Store GPA per term
  const [showCriteria, setShowCriteria] = useState(true);
  const [admissionMode, setAdmissionMode] = useState('M1'); 

  // Criteria State
  const [criteria, setCriteria] = useState({
    gpax: 3.00,
    Science: 3.00,
    Math: 3.00,
    Language: 0,
    Thai: 0,
    Social: 0
  });

  const categories = [
    { id: 'Thai', label: 'ภาษาไทย', icon: BookOpen, color: 'text-gray-700', bg: 'bg-white', border: 'border-gray-300' },
    { id: 'Math', label: 'คณิตศาสตร์', icon: CalcIcon, color: 'text-gray-700', bg: 'bg-white', border: 'border-gray-300' },
    { id: 'Science', label: 'วิทยาศาสตร์', icon: FlaskConical, color: 'text-gray-700', bg: 'bg-white', border: 'border-gray-300' },
    { id: 'Social', label: 'สังคมศึกษาฯ', icon: Globe, color: 'text-gray-700', bg: 'bg-white', border: 'border-gray-300' },
    { id: 'Health', label: 'สุขศึกษา/พละ', icon: HeartPulse, color: 'text-gray-700', bg: 'bg-white', border: 'border-gray-300' },
    { id: 'Arts', label: 'ศิลปะ', icon: Palette, color: 'text-gray-700', bg: 'bg-white', border: 'border-gray-300' },
    { id: 'Career', label: 'การงานอาชีพ', icon: Briefcase, color: 'text-gray-700', bg: 'bg-white', border: 'border-gray-300' },
    { id: 'Language', label: 'ภาษาต่างประเทศ', icon: Languages, color: 'text-gray-700', bg: 'bg-white', border: 'border-gray-300' },
    { id: 'Others', label: 'เพิ่มเติม/อื่นๆ', icon: MoreHorizontal, color: 'text-gray-700', bg: 'bg-white', border: 'border-gray-300' },
  ];

  const termOptionsM1 = ['ป.4 เทอม 1', 'ป.4 เทอม 2', 'ป.5 เทอม 1', 'ป.5 เทอม 2', 'ป.6 เทอม 1'];
  const termOptionsM4 = ['ม.1 เทอม 1', 'ม.1 เทอม 2', 'ม.2 เทอม 1', 'ม.2 เทอม 2', 'ม.3 เทอม 1'];

  const gradeValues = {
    '4': 4.0, '3.5': 3.5, '3': 3.0, '2.5': 2.5, '2': 2.0, '1.5': 1.5, '1': 1.0, '0': 0.0,
    'A': 4.0, 'B+': 3.5, 'B': 3.0, 'C+': 2.5, 'C': 2.0, 'D+': 1.5, 'D': 1.0, 'F': 0.0
  };

  const displayGradeKeys = ['4', '3.5', '3', '2.5', '2', '1.5', '1', '0'];

  const standardSubjects = [
    { name: 'ภาษาไทยพื้นฐาน', category: 'Thai', credit: 1.5 },
    { name: 'คณิตศาสตร์พื้นฐาน', category: 'Math', credit: 1.5 },
    { name: 'วิทยาศาสตร์พื้นฐาน', category: 'Science', credit: 1.5 },
    { name: 'สังคมศึกษาฯ', category: 'Social', credit: 1.5 },
    { name: 'ประวัติศาสตร์', category: 'Social', credit: 0.5 },
    { name: 'สุขศึกษาและพลศึกษา', category: 'Health', credit: 1.0 },
    { name: 'ศิลปะ', category: 'Arts', credit: 1.0 },
    { name: 'การงานอาชีพ', category: 'Career', credit: 0.5 },
    { name: 'ภาษาอังกฤษพื้นฐาน', category: 'Language', credit: 1.5 },
  ];

  useEffect(() => {
    calculateAll();
  }, [subjects]);

  const calculateAll = () => {
    let sumPoints = 0;
    let sumCredits = 0;
    
    // Category Stats
    const catStats = {};
    categories.forEach(c => {
      catStats[c.id] = { sumPoints: 0, sumCredits: 0, gpa: 0.00, count: 0 };
    });

    // Term Stats
    const tStats = {};

    subjects.forEach(sub => {
      const point = gradeValues[sub.grade];
      if (point !== undefined && point !== null) {
        const credit = parseFloat(sub.credit);
        
        // Overall
        sumPoints += point * credit;
        sumCredits += credit;

        // Category
        const cat = sub.category || 'Others';
        if (catStats[cat]) {
          catStats[cat].sumPoints += point * credit;
          catStats[cat].sumCredits += credit;
          catStats[cat].count += 1;
        }

        // Term
        if (!tStats[sub.term]) {
            tStats[sub.term] = { sumPoints: 0, sumCredits: 0, gpa: 0.00 };
        }
        tStats[sub.term].sumPoints += point * credit;
        tStats[sub.term].sumCredits += credit;
      }
    });

    // Finalize Calculations
    Object.keys(catStats).forEach(key => {
      if (catStats[key].sumCredits > 0) {
        catStats[key].gpa = (catStats[key].sumPoints / catStats[key].sumCredits).toFixed(2);
      } else {
        catStats[key].gpa = '-';
      }
    });

    Object.keys(tStats).forEach(key => {
        if (tStats[key].sumCredits > 0) {
            tStats[key].gpa = (tStats[key].sumPoints / tStats[key].sumCredits).toFixed(2);
        } else {
            tStats[key].gpa = 0.00;
        }
    });

    setTotalCredits(sumCredits);
    setGpa(sumCredits > 0 ? (sumPoints / sumCredits).toFixed(2) : 0.00);
    setCategoryStats(catStats);
    setTermStats(tStats);
  };

  const handleAddSubject = (e) => {
    e.preventDefault();
    if (!newSubject.name || !newSubject.credit) return;

    const subject = {
      id: Date.now(),
      term: newSubject.term,
      name: newSubject.name,
      credit: parseFloat(newSubject.credit),
      grade: newSubject.grade,
      category: newSubject.category
    };

    setSubjects([...subjects, subject]);
    setNewSubject({ ...newSubject, name: '', grade: '4' });
  };

  const handleDelete = (id) => {
    setSubjects(subjects.filter(sub => sub.id !== id));
  };

  const handleReset = () => {
    if (window.confirm('ยืนยันการล้างข้อมูลทั้งหมด?')) {
      setSubjects([]);
      setCategoryStats({});
      setTermStats({});
    }
  };

  const checkPass = (current, target) => {
    if (!target) return null;
    if (current === '-') return false;
    return parseFloat(current) >= parseFloat(target);
  };

  const generateTemplate = (mode) => {
    if (!window.confirm(`ระบบจะสร้างรายการวิชาสำหรับ "${mode === 'M1' ? 'เข้า ม.1' : 'เข้า ม.4'}" ใหม่ทั้งหมด ข้อมูลเดิมจะถูกลบ ยืนยันหรือไม่?`)) return;

    const terms = mode === 'M1' 
      ? ['ป.4 เทอม 1', 'ป.4 เทอม 2', 'ป.5 เทอม 1', 'ป.5 เทอม 2'] 
      : ['ม.1 เทอม 1', 'ม.1 เทอม 2', 'ม.2 เทอม 1', 'ม.2 เทอม 2', 'ม.3 เทอม 1'];

    let newSubjects = [];
    let idCounter = Date.now();

    terms.forEach(term => {
      standardSubjects.forEach(template => {
        newSubjects.push({
          id: idCounter++,
          term: term,
          name: template.name,
          category: template.category,
          credit: template.credit,
          grade: '4' 
        });
      });
    });

    setSubjects(newSubjects);
    setAdmissionMode(mode);
    setNewSubject({ ...newSubject, term: terms[0] });
  };

  const currentTermOptions = admissionMode === 'M1' ? termOptionsM1 : termOptionsM4;
  
  const subjectsByTerm = subjects.reduce((acc, sub) => {
    if (!acc[sub.term]) acc[sub.term] = [];
    acc[sub.term].push(sub);
    return acc;
  }, {});
  
  const displayedTerms = Object.keys(subjectsByTerm).sort((a, b) => a.localeCompare(b));

  return (
    <div className="min-h-screen bg-slate-100 p-4 md:p-8 font-sarabun text-slate-900">
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        .font-sarabun { font-family: 'Sarabun', sans-serif; }
      `}</style>

      <div className="max-w-7xl mx-auto space-y-6">
        
        {/* Official Header */}
        <header className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden">
          <div className="bg-slate-800 text-white p-4 flex justify-between items-center">
             <div className="flex items-center gap-3">
                <div className="p-2 bg-white/10 rounded-lg">
                  <Calculator size={24} />
                </div>
                <div>
                  <h1 className="text-xl font-bold">ระบบตรวจสอบผลการเรียน (GPA Calculator)</h1>
                  <p className="text-xs text-slate-300">สำหรับตรวจสอบคุณสมบัติการศึกษาต่อ ม.1 และ ม.4</p>
                </div>
             </div>
             <div className="text-right hidden md:block">
                <div className="text-xs opacity-70">วันที่คำนวณ</div>
                <div className="font-medium">{new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric'})}</div>
             </div>
          </div>
          
          <div className="p-6 grid md:grid-cols-12 gap-6 items-center">
            {/* Control Panel */}
            <div className="md:col-span-8 space-y-4">
                <div className="flex flex-wrap gap-2">
                    <button 
                        onClick={() => generateTemplate('M1')}
                        className={`flex items-center gap-2 px-4 py-2 rounded-md border text-sm font-medium transition-all ${admissionMode === 'M1' ? 'bg-blue-50 border-blue-600 text-blue-700' : 'bg-white border-slate-300 text-slate-600 hover:bg-slate-50'}`}
                    >
                        <FileSpreadsheet size={16}/> โหลดโครงสร้าง ป.4 - ป.6 (เข้า ม.1)
                    </button>
                    <button 
                        onClick={() => generateTemplate('M4')}
                        className={`flex items-center gap-2 px-4 py-2 rounded-md border text-sm font-medium transition-all ${admissionMode === 'M4' ? 'bg-blue-50 border-blue-600 text-blue-700' : 'bg-white border-slate-300 text-slate-600 hover:bg-slate-50'}`}
                    >
                        <FileSpreadsheet size={16}/> โหลดโครงสร้าง ม.1 - ม.3 (เข้า ม.4)
                    </button>
                    <button 
                        onClick={() => window.print()}
                        className="flex items-center gap-2 px-4 py-2 bg-white border border-slate-300 text-slate-600 rounded-md hover:bg-slate-50 transition-colors font-medium text-sm ml-auto"
                    >
                        <Printer size={16}/> พิมพ์รายงาน
                    </button>
                </div>
                <div className="p-3 bg-blue-50 border border-blue-100 rounded-md text-sm text-blue-800 flex items-start gap-2">
                    <Target size={18} className="shrink-0 mt-0.5"/>
                    <span>
                        <strong>คำแนะนำ:</strong> กรุณาเลือกโหลดโครงสร้างวิชาตามระดับชั้นที่ต้องการสมัคร จากนั้นแก้ไขเกรดในตารางด้านล่างให้ตรงกับใบ ปพ.1 ของท่าน
                    </span>
                </div>
            </div>

            {/* GPAX Display */}
            <div className="md:col-span-4 flex flex-col justify-center">
                <div className={`p-4 rounded-lg border-2 text-center transition-colors ${
                    checkPass(gpa, criteria.gpax) === false ? 'bg-red-50 border-red-200 text-red-700' : 
                    checkPass(gpa, criteria.gpax) === true ? 'bg-green-50 border-green-200 text-green-700' : 'bg-white border-slate-200 text-slate-700'
                }`}>
                    <div className="text-xs font-bold uppercase tracking-wider mb-1 opacity-70">เกรดเฉลี่ยสะสม (GPAX)</div>
                    <div className="text-5xl font-bold font-mono tracking-tight">{gpa}</div>
                    <div className="text-sm mt-2 font-medium flex justify-center items-center gap-2">
                        <span>หน่วยกิตรวม: {totalCredits}</span>
                        {criteria.gpax > 0 && (
                            <span className={`text-xs px-2 py-0.5 rounded-full border ${checkPass(gpa, criteria.gpax) ? 'bg-green-100 border-green-300' : 'bg-red-100 border-red-300'}`}>
                                เกณฑ์ขั้นต่ำ {criteria.gpax.toFixed(2)}
                            </span>
                        )}
                    </div>
                </div>
            </div>
          </div>
        </header>

        <div className="grid lg:grid-cols-12 gap-6 items-start">
            
            {/* LEFT SIDE: Settings & Inputs */}
            <div className="lg:col-span-4 space-y-6">
                
                {/* Criteria Settings */}
                <div className="bg-white rounded-lg shadow-sm border border-slate-200">
                    <div 
                        className="px-4 py-3 bg-slate-50 border-b border-slate-200 flex items-center justify-between cursor-pointer"
                        onClick={() => setShowCriteria(!showCriteria)}
                    >
                        <h3 className="font-semibold text-slate-700 flex items-center gap-2">
                            <Target size={18} className="text-blue-600"/>
                            กำหนดเกณฑ์ขั้นต่ำ (Criteria)
                        </h3>
                        {showCriteria ? <ChevronUp size={16}/> : <ChevronDown size={16}/>}
                    </div>
                    
                    {showCriteria && (
                    <div className="p-4 space-y-4">
                        <div className="grid gap-4">
                            <div>
                                <label className="block text-sm font-medium text-slate-600 mb-1">GPAX ขั้นต่ำ</label>
                                <input 
                                    type="number" step="0.01" 
                                    className="w-full px-3 py-2 bg-white border border-slate-300 rounded-md focus:ring-1 focus:ring-blue-500 focus:border-blue-500 outline-none text-slate-800"
                                    value={criteria.gpax}
                                    onChange={(e) => setCriteria({...criteria, gpax: parseFloat(e.target.value) || 0})}
                                />
                            </div>
                            
                            <div className="border-t border-slate-100 pt-3">
                                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-3 block">เกรดรายวิชาพื้นฐาน (เฉลี่ยทุกเทอม)</label>
                                <div className="space-y-3">
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded bg-purple-100 text-purple-700 flex items-center justify-center"><FlaskConical size={16}/></div>
                                        <div className="flex-1">
                                            <div className="text-sm font-medium">วิทยาศาสตร์</div>
                                            <input 
                                                type="number" step="0.01" placeholder="-"
                                                className="w-full mt-1 px-2 py-1 text-sm border border-slate-300 rounded focus:border-blue-500 outline-none"
                                                value={criteria.Science || ''}
                                                onChange={(e) => setCriteria({...criteria, Science: parseFloat(e.target.value) || 0})}
                                            />
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded bg-blue-100 text-blue-700 flex items-center justify-center"><CalcIcon size={16}/></div>
                                        <div className="flex-1">
                                            <div className="text-sm font-medium">คณิตศาสตร์</div>
                                            <input 
                                                type="number" step="0.01" placeholder="-"
                                                className="w-full mt-1 px-2 py-1 text-sm border border-slate-300 rounded focus:border-blue-500 outline-none"
                                                value={criteria.Math || ''}
                                                onChange={(e) => setCriteria({...criteria, Math: parseFloat(e.target.value) || 0})}
                                            />
                                        </div>
                                    </div>
                                    <div className="flex items-center gap-3">
                                        <div className="w-8 h-8 rounded bg-pink-100 text-pink-700 flex items-center justify-center"><Languages size={16}/></div>
                                        <div className="flex-1">
                                            <div className="text-sm font-medium">ภาษาอังกฤษ</div>
                                            <input 
                                                type="number" step="0.01" placeholder="-"
                                                className="w-full mt-1 px-2 py-1 text-sm border border-slate-300 rounded focus:border-blue-500 outline-none"
                                                value={criteria.Language || ''}
                                                onChange={(e) => setCriteria({...criteria, Language: parseFloat(e.target.value) || 0})}
                                            />
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    )}
                </div>

                {/* Subject Summary Card */}
                <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-4">
                    <h3 className="font-semibold text-slate-700 mb-3 flex items-center gap-2">
                        <CheckCircle2 size={18} className="text-green-600"/>
                        สรุปสถานะรายวิชา
                    </h3>
                    <div className="space-y-2">
                         {categories.map(cat => {
                            const stats = categoryStats[cat.id] || { gpa: '-', sumCredits: 0 };
                            const target = criteria[cat.id];
                            if (stats.sumCredits === 0 && !target) return null;
                            const isPassed = checkPass(stats.gpa, target);
                            
                            return (
                                <div key={cat.id} className="flex justify-between items-center text-sm border-b border-slate-100 pb-2 last:border-0 last:pb-0">
                                    <span className="text-slate-600 flex items-center gap-2">
                                        <div className={`w-2 h-2 rounded-full ${isPassed === false ? 'bg-red-500' : 'bg-green-500'}`}></div>
                                        {cat.label}
                                    </span>
                                    <div className="text-right">
                                        <span className={`font-bold ${isPassed === false ? 'text-red-600' : 'text-slate-800'}`}>{stats.gpa}</span>
                                        {target > 0 && <span className="text-xs text-slate-400 ml-2">/ {target}</span>}
                                    </div>
                                </div>
                            )
                         })}
                    </div>
                </div>

                {/* Add Subject Form */}
                <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-4 sticky top-6">
                    <h3 className="font-semibold text-slate-700 mb-4 flex items-center gap-2">
                        <Plus size={18} className="text-blue-600"/>
                        เพิ่มรายวิชาเพิ่มเติม
                    </h3>
                    <form onSubmit={handleAddSubject} className="space-y-3">
                        <select
                              value={newSubject.term}
                              onChange={(e) => setNewSubject({...newSubject, term: e.target.value})}
                              className="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm outline-none focus:border-blue-500"
                        >
                            {currentTermOptions.map(t => <option key={t} value={t}>{t}</option>)}
                        </select>
                        <select
                            value={newSubject.category}
                            onChange={(e) => setNewSubject({...newSubject, category: e.target.value})}
                            className="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm outline-none focus:border-blue-500"
                        >
                            {categories.map(c => <option key={c.id} value={c.id}>{c.label}</option>)}
                        </select>
                        <input
                            type="text"
                            placeholder="ชื่อวิชา"
                            value={newSubject.name}
                            onChange={(e) => setNewSubject({...newSubject, name: e.target.value})}
                            className="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm outline-none focus:border-blue-500"
                            required
                        />
                        <div className="grid grid-cols-2 gap-2">
                            <input
                                type="number" step="0.5" placeholder="หน่วยกิต"
                                value={newSubject.credit}
                                onChange={(e) => setNewSubject({...newSubject, credit: e.target.value})}
                                className="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm outline-none focus:border-blue-500"
                                required
                            />
                            <select
                                value={newSubject.grade}
                                onChange={(e) => setNewSubject({...newSubject, grade: e.target.value})}
                                className="w-full px-3 py-2 bg-slate-50 border border-slate-300 rounded-md text-sm outline-none focus:border-blue-500"
                            >
                                {displayGradeKeys.map(g => <option key={g} value={g}>{g}</option>)}
                            </select>
                        </div>
                        <button type="submit" className="w-full py-2 bg-blue-600 text-white rounded-md text-sm font-medium hover:bg-blue-700 transition-colors shadow-sm">
                            บันทึกรายการ
                        </button>
                    </form>
                </div>
            </div>

            {/* RIGHT SIDE: Data Table */}
            <div className="lg:col-span-8 space-y-6">
                <div className="bg-white rounded-lg shadow-sm border border-slate-200 overflow-hidden min-h-[600px] flex flex-col">
                    <div className="px-6 py-4 border-b border-slate-200 flex justify-between items-center bg-slate-50">
                        <h2 className="font-bold text-slate-800 flex items-center gap-2">
                            <FileSpreadsheet size={20} className="text-blue-600"/>
                            ผลการเรียนรายภาคเรียน
                        </h2>
                        <button 
                            onClick={handleReset}
                            className="text-xs text-red-600 hover:text-red-700 hover:bg-red-50 px-3 py-1.5 rounded border border-transparent hover:border-red-200 transition-all flex items-center gap-1"
                        >
                            <Trash2 size={14} /> ล้างข้อมูลทั้งหมด
                        </button>
                    </div>

                    <div className="flex-1 p-6 space-y-8 bg-slate-50/50 overflow-y-auto max-h-[800px]">
                        {subjects.length === 0 ? (
                            <div className="flex flex-col items-center justify-center h-full text-slate-400 py-20">
                                <div className="bg-slate-100 p-4 rounded-full mb-4"><GraduationCap size={40} className="opacity-20"/></div>
                                <p className="font-medium">ไม่พบข้อมูลรายวิชา</p>
                                <p className="text-sm">กรุณากดปุ่ม "โหลดโครงสร้าง" ด้านบนเพื่อเริ่มใช้งาน</p>
                            </div>
                        ) : (
                            displayedTerms.map((term, index) => {
                                const tStat = termStats[term] || { gpa: '0.00', sumCredits: 0 };
                                return (
                                <div key={term} className="bg-white border border-slate-200 rounded-lg shadow-sm overflow-hidden print:shadow-none print:border-black">
                                    <div className="bg-slate-100 px-4 py-2 border-b border-slate-200 flex justify-between items-center">
                                        <div className="font-bold text-slate-700 flex items-center gap-2 text-sm">
                                            <Calendar size={14}/> {term}
                                        </div>
                                        <div className="text-xs font-semibold text-slate-600 bg-white px-2 py-0.5 rounded border border-slate-200">
                                            หน่วยกิตเทอม: {tStat.sumCredits} | GPA เทอม: <span className="text-blue-700 text-sm">{tStat.gpa}</span>
                                        </div>
                                    </div>
                                    <table className="w-full text-left border-collapse text-sm">
                                        <thead>
                                            <tr className="bg-white text-slate-500 border-b border-slate-100 text-xs uppercase tracking-wide">
                                                <th className="px-4 py-2 font-semibold w-12 text-center">#</th>
                                                <th className="px-4 py-2 font-semibold">รายวิชา</th>
                                                <th className="px-4 py-2 font-semibold w-24 text-center">หน่วยกิต</th>
                                                <th className="px-4 py-2 font-semibold w-24 text-center">เกรด</th>
                                                <th className="px-4 py-2 font-semibold w-24 text-center">คะแนน</th>
                                                <th className="px-4 py-2 w-10"></th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {subjectsByTerm[term].map((sub, i) => {
                                                const catInfo = categories.find(c => c.id === sub.category) || categories[8];
                                                const point = gradeValues[sub.grade] || 0;
                                                const totalPoint = point * parseFloat(sub.credit);
                                                
                                                return (
                                                <tr key={sub.id} className="hover:bg-blue-50/30 transition-colors group">
                                                    <td className="px-4 py-2 text-center text-slate-400 text-xs">{i + 1}</td>
                                                    <td className="px-4 py-2">
                                                        <div className="font-medium text-slate-800">{sub.name}</div>
                                                        <div className="text-[10px] text-slate-400 mt-0.5">{catInfo.label}</div>
                                                    </td>
                                                    <td className="px-4 py-2 text-center text-slate-600">{sub.credit}</td>
                                                    <td className="px-4 py-2 text-center">
                                                        <select 
                                                            className={`w-full text-center text-xs font-bold py-1 rounded cursor-pointer outline-none border transition-all ${
                                                                ['4', '3.5', 'A', 'B+'].includes(sub.grade.toString()) ? 'bg-green-50 text-green-700 border-green-200' :
                                                                ['1', '1.5', '0', 'F', 'D'].includes(sub.grade.toString()) ? 'bg-red-50 text-red-700 border-red-200' :
                                                                'bg-white text-slate-700 border-slate-200 hover:border-blue-300'
                                                            }`}
                                                            value={sub.grade}
                                                            onChange={(e) => {
                                                                const updated = subjects.map(s => s.id === sub.id ? {...s, grade: e.target.value} : s);
                                                                setSubjects(updated);
                                                            }}
                                                        >
                                                            {displayGradeKeys.map(g => (
                                                                <option key={g} value={g}>{g}</option>
                                                            ))}
                                                        </select>
                                                    </td>
                                                    <td className="px-4 py-2 text-center text-slate-400 text-xs font-mono">
                                                        {totalPoint.toFixed(1)}
                                                    </td>
                                                    <td className="px-4 py-2 text-center">
                                                        <button 
                                                            onClick={() => handleDelete(sub.id)}
                                                            className="text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"
                                                            title="ลบรายวิชา"
                                                        >
                                                            <Trash2 size={14}/>
                                                        </button>
                                                    </td>
                                                </tr>
                                                );
                                            })}
                                        </tbody>
                                    </table>
                                </div>
                            )})
                        )}
                    </div>
                </div>
            </div>

        </div>
      </div>
    </div>
  );
}
